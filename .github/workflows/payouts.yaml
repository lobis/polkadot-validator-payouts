name: Validator Payments

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # Every day at 00:00 UTC

concurrency:
  group: validator-payments
  cancel-in-progress: true

jobs:
  build:
    name: Build Docker image
    runs-on: ubuntu-latest
    outputs:
      image-name: crunch:latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Checkout turboflakes/crunch
        uses: actions/checkout@v4
        with:
          repository: turboflakes/crunch
          path: crunch-repo

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image from turboflakes/crunch Dockerfile
        run: |
          docker build -f crunch-repo/Dockerfile.alpine -t crunch:latest crunch-repo

      - name: Save Docker image as artifact
        run: docker save crunch:latest | gzip > crunch-image.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: crunch-image
          path: crunch-image.tar.gz

  kusama-payments:
    name: Kusama Payments
    runs-on: ubuntu-latest
    needs: build
    env:
      SEED_FILE: ./seed.txt
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: crunch-image

      - name: Load Docker image
        run: docker load < crunch-image.tar.gz

      - name: Write seed to file
        run: echo "${{ secrets.PAYOUTS_ACCOUNT_SEED }}" > $SEED_FILE

      - name: Read validator stashes
        id: kusama_stashes
        run: |
          STASHES=$(awk '{ sub(/\r$/,""); if (length($0)) { printf "%s%s", sep, $0; sep="," } } END { print "" }' validators/kusama)
          echo "stashes=$STASHES" >> $GITHUB_OUTPUT

      - name: Run Crunch (Kusama)
        run: |
          docker run --rm \
            -v $(pwd)/$SEED_FILE:/seed.txt \
            crunch:latest kusama \
            --stashes ${{ steps.kusama_stashes.outputs.stashes }} \
            rewards \
            --maximum-history-eras 84 \
            --maximum-calls 4 \
            --disable-matrix \
            --seed-path /seed.txt \
            once

  polkadot-payments:
    name: Polkadot Payments
    runs-on: ubuntu-latest
    needs: build
    env:
      SEED_FILE: ./seed.txt
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: crunch-image

      - name: Load Docker image
        run: docker load < crunch-image.tar.gz

      - name: Write seed to file
        run: echo "${{ secrets.PAYOUTS_ACCOUNT_SEED }}" > $SEED_FILE

      - name: Read validator stashes
        id: polkadot_stashes
        run: |
          STASHES=$(awk '{ sub(/\r$/,""); if (length($0)) { printf "%s%s", sep, $0; sep="," } } END { print "" }' validators/polkadot)
          echo "stashes=$STASHES" >> $GITHUB_OUTPUT

      - name: Run Crunch (Polkadot)
        run: |
          docker run --rm \
            -v $(pwd)/$SEED_FILE:/seed.txt \
            crunch:latest polkadot \
            --stashes ${{ steps.polkadot_stashes.outputs.stashes }} \
            rewards \
            --maximum-history-eras 84 \
            --maximum-calls 4 \
            --disable-matrix \
            --seed-path /seed.txt \
            once
